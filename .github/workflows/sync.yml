name: ğŸ”„ Sync fork with upstream

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 11ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout your fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”— Add upstream remote
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git
          git fetch upstream
          echo "âœ… Fetched upstream successfully."

      - name: ğŸ“‹ Show current local and remote status
        run: |
          echo "=== Local branch ==="
          git log --oneline -3
          echo ""
          echo "=== Upstream/main ==="
          git log --oneline upstream/main -3
          echo ""
          echo "=== Origin/main (your fork) ==="
          git log --oneline origin/main -3

      - name: ğŸ”„ Try to merge upstream
        id: merge
        run: |
          BRANCH="main"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet HEAD upstream/$BRANCH; then
            echo "ğŸ” No changes between your branch and upstream."
            echo "status=no_update" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¥ New commits detected in upstream. Merging..."
            if git merge upstream/$BRANCH; then
              echo "âœ… Merge successful."
              echo "status=updated" >> $GITHUB_OUTPUT
            else
              echo "âŒ Merge failed (likely conflict or non-fast-forward)."
              echo "status=merge_failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: ğŸ“¤ Push to your fork (if updated)
        if: steps.merge.outputs.status == 'updated'
        run: |
          BRANCH="main"
          echo "ğŸ“¤ Pushing updates to your fork..."
          git push --force-with-lease origin $BRANCH
          echo "âœ… Successfully synced your fork with upstream!"

      - name: â„¹ï¸ No update needed
        if: steps.merge.outputs.status == 'no_update'
        run: |
          echo "â„¹ï¸ Your fork is already up-to-date with upstream. Nothing to do."

      - name: âŒ Handle merge failure (optional)
        if: failure() && steps.merge.outputs.status == 'merge_failed'
        run: |
          echo "ğŸš¨ Manual intervention may be required due to merge conflict."
