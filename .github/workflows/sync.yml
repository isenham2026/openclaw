name: ğŸ”„ Sync fork with upstream

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 11ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout your fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”— Add upstream remote
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git
          git fetch upstream
          echo "âœ… Fetched upstream successfully."

      - name: ğŸ“‹ Show current local and remote status
        run: |
          echo "=== Local branch (your main) ==="
          git log --oneline -3
          echo ""
          echo "=== Upstream/main ==="
          git log --oneline upstream/main -3
          echo ""
          echo "=== Origin/main (your fork on GitHub) ==="
          git log --oneline origin/main -3

      - name: ğŸ”„ Check for meaningful changes (ignore .github/)
        id: check
        run: |
          BRANCH="main"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Compare all files EXCEPT .github/ directory
          if git diff --quiet HEAD upstream/$BRANCH -- . ':(exclude).github' ':(exclude).npmrc'; then
            echo "ğŸ” No meaningful changes in upstream (ignoring .github/ and .npmrc)."
            echo "status=no_update" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¥ Meaningful changes detected in upstream. Merging..."
            if git merge upstream/$BRANCH; then
              echo "âœ… Merge successful."
              echo "status=updated" >> $GITHUB_OUTPUT
            else
              echo "âŒ Merge failed (likely conflict)."
              echo "status=merge_failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: ğŸ“¤ Push to your fork (if updated)
        if: steps.check.outputs.status == 'updated'
        run: |
          BRANCH="main"
          echo "ğŸ“¤ Pushing updates to your fork..."
          git push origin $BRANCH
          echo "âœ… Successfully synced your fork with upstream!"

      - name: â„¹ï¸ No meaningful update needed
        if: steps.check.outputs.status == 'no_update'
        run: |
          echo "â„¹ï¸ Your fork is already up-to-date with upstream (code-wise). Nothing to do."

      - name: âŒ Handle merge failure
        if: failure() && steps.check.outputs.status == 'merge_failed'
        run: |
          echo "ğŸš¨ Manual intervention may be required due to merge conflict."
